# Training `GWAK`

This repository contains a `Snakefile` that pipelines the training of contrastive learning (CL) models and flow models (FM), and produces evaluation plots using trained models. The workflow is defined using [Snakemake](https://snakemake.readthedocs.io/).

## Overview

The workflow consists of three main steps:

1. **`train_cl`** â€“ Train a contrastive learning model.
2. **`train_fm`** â€“ Train a flow model on embeddings generated by a CL model.
3. **`make_plots`** â€“ Generate evaluation plots using trained CL and FM models.

## Configuration

The pipeline supports multiple training configurations, which are specified as YAML files in the `train/configs/` directory.

### Supported CL Configurations

- `Transformer_SimCLR_multiSignal_all`
- `Transformer_SimCLR_multiSignalAndBkg_noSG`
- `S4_SimCLR_multiSignalAndBkg`

### Supported FM Configurations

- `NF_onlyBkg`
- `FM_multiSignalAndBkg`

## ðŸ”— Rule Dependencies

The workflow is structured into three dependent stages, where each stage builds upon the outputs of the previous one:

---

### âž¤ Step 1: `train_cl`

Trains a contrastive learning (CL) model based on a given configuration.

- **Input:** `train/configs/{cl_config}.yaml`
- **Output:** `output/{cl_config}/model.pt`
- âœ… **Must complete before:** `train_fm`

---

### âž¤ Step 2: `train_fm`

Trains a flow model (FM) using the embedding model generated by `train_cl`.

- **Input:**
  - CL model: `output/{cl_config}/model.pt`
  - Config: `train/configs/{fm_config}.yaml`
- **Output:** `output/{cl_config}_{fm_config}/model.pt`
- âœ… **Depends on:** `train_cl`
- âœ… **Must complete before:** `make_plots`

---

### âž¤ Step 3: `make_plots`

Generates evaluation plots using the CL and FM models trained in the previous steps.

- **Input:**
  - `output/{cl_config}/model.pt` (from `train_cl`)
  - `output/{cl_config}_{fm_config}/model.pt` (from `train_fm`)
  - Background data and config
- **Output:** `output/plots/`
- âœ… **Depends on:** both `train_cl` and `train_fm`